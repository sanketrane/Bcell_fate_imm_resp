setwd("~/cmdstan/Bcell_fate_imm_resp")
rm(list = ls()); gc();
############################################################
### Preamble
############################################################
## loading libraries
library(tidyverse)
library(readxl)
library("ggsci")
#### plotting style
myTheme <- theme(text = element_text(size = 12), axis.text = element_text(size = 12),
axis.title =  element_text(size = 12, face = "bold"),
plot.title = element_text(size=12,  hjust = 0.5, face = "bold"),
#legend.title = element_text(size=12,  hjust = 0.5, face = "bold"),
legend.background = element_blank(),
legend.box.background =  element_blank(),
legend.key = element_blank())
# setting ggplot theme for rest fo the plots
theme_set(theme_bw())
fancy_scientific <- function(l) {
# turn in to character string in scientific notation
l <- format(l, scientific = TRUE)
# quote the part before the exponent to keep all the digits
l <- gsub("^(.*)e", "'\\1'e", l)
# remove + after exponent, if exists. E.g.: (e^+2 -> e^2)
l <- gsub("e\\+","e",l)
# turn the 'e' into plotmath format
l <- gsub("e", "%*%10^", l)
# convert 1x10^ or 1.000x10^ -> 10^
l <- gsub("\\'1[\\.0]*\\'\\%\\*\\%", "", l)
# return this as an expression
parse(text=l)
}
log10minorbreaks = as.numeric(1:10 %o% 10^(-4:8))
############################################################
############################################################
## import data
############################################################
## Immune response dynamics of B cells -- reporter induction upon b cell activation
B_cell_data <- read_excel("datafiles/New_dataCAR.xlsx", sheet =2) %>%
mutate(mouse.id = paste0('m_', seq(1, 72))) %>%
filter(mouse.id != "m_1")
B_cell_countsWT_df <- B_cell_data %>%
filter(genotype == "CAR", days_post_imm > 0) %>%
select(days_post_imm, genotype, contains('CARpos')) %>%
gather(-c(days_post_imm, genotype), key = "subpop", value="cell_counts")%>%
mutate(#CARexpr = ifelse(grepl("CARpos", subpop), "CARpos", "CARneg"),
subplop = ifelse(grepl("Fo", subpop), "FoB", ifelse(grepl("GC", subpop), "GCB", ifelse(grepl("MZ", subpop), "MZB", "TotalB"))))
B_cell_countsN2_df <- B_cell_data %>%
filter(genotype == "N2KO", days_post_imm > 0) %>%
select(days_post_imm, genotype, contains('CARpos')) %>%
gather(-c(days_post_imm, genotype), key = "subpop", value="cell_counts")%>%
mutate(#CARexpr = ifelse(grepl("CARpos", subpop), "CARpos", "CARneg"),
subplop = ifelse(grepl("Fo", subpop), "FoB", ifelse(grepl("GC", subpop), "GCB", ifelse(grepl("MZ", subpop), "MZB", "TotalB"))))
blank_data <- data.frame(subplop = c('FoB', 'FoB', 'GCB', 'GCB', 'MZB', 'MZB','TotalB', 'TotalB'),
cell_counts = c(5e4, 3e6, 1e4, 3e6, 1e4, 5e5, 1e5, 5e6),
days_post_imm = rep(c(4, 30), 4),
CARexpr = rep("CARpos", 8))
Bcell_all_data <- rbind(B_cell_countsWT_df, B_cell_countsN2_df) %>%
mutate(mouse_strain = ifelse(grepl("CAR", genotype), "WT", "N2KO"))
ggplot() +
geom_point(data=Bcell_all_data, aes(x= days_post_imm, y=cell_counts, col= mouse_strain), size=1.7) +
scale_color_manual(values = c("#CA0636", "#0B78BA"), name=NULL) +
#geom_point(data=CAR_cell_counts_df, aes(x= (days_post_imm), y=(cell_counts)), col="navy",size=2, alpha=0.7) +
geom_blank(data=blank_data, aes(x= (days_post_imm), y=(cell_counts))) +
scale_y_log10(labels=fancy_scientific) +
labs(x='Days post immunization', y='Cell counts')+
facet_wrap(. ~ subplop, scales = 'free') + myTheme
View(B_cell_countsN2_df)
View(B_cell_countsWT_df)
View(B_cell_data)
#### plotting correlations
CAR_cell_counts_df <- B_cell_data %>%
filter(genotype == "CAR", days_post_imm >=0) %>%
mutate(days_bin = ifelse(days_post_imm < 7, "1Wk",
ifelse(days_post_imm <14, "2Wk",
ifelse(days_post_imm <21, "3Wk", "4Wk"))))
corFOMZ <- cor.test(B_cell_data$CARpos_FoB, B_cell_data$CARpos_MZB)
corGCMZ <- cor.test(B_cell_data$CARpos_GCB, B_cell_data$CARpos_MZB)
corFOGC <- cor.test(B_cell_data$CARpos_FoB, B_cell_data$CARpos_GCB)
p11 <-ggplot(data = CAR_cell_counts_df)+
geom_point(aes(x=log(CARpos_FoB), y=log(CARpos_MZB), col=days_bin), size=2)+
#scale_color_manual(values = wesanderson::wes_palette("Zissou1", n=4, type = 'continuous'))+
scale_color_npg()+ guides(col='none') +
labs(x="Log(Counts of CAR positive FoB)", y="Log(Counts of CAR positive MZB)")+
geom_text(x=12.3, y=12.4, label=paste0("r=", round(corFOMZ$estimate, 2)), col='darkred', size=5) +myTheme
p22 <-ggplot(data = CAR_cell_counts_df) +
geom_point(aes(x=log(CARpos_GCB), y=log(CARpos_MZB), col=days_bin), size=2)+
#scale_color_manual(values = wesanderson::wes_palette("Zissou1", n=4, type = 'continuous'))+
scale_color_npg()+ guides(col='none') +
labs(x="Log(Counts of CAR positive GCB)", y="Log(Counts of CAR positive MZB)")+
geom_text(x=11, y=12.4, label=paste0("r=", round(corGCMZ$estimate, 2)), col='darkred', size=5)+ myTheme
p33 <- ggplot(data = CAR_cell_counts_df)+
geom_point(aes(x=log(CARpos_FoB), y=log(CARpos_GCB), col=days_bin), size=2) +
labs(x="Log(Counts of CAR positive FoB)", y="Log(Counts of CAR positive GCB)") +
geom_text(x=12.3, y=14.8, label=paste0("r=", round(corFOGC$estimate, 2)), col='darkred',  size=5) +
scale_color_npg(name = "Days post\nimmunization") + myTheme + theme(legend.position = c(0.85, 0.2))
cowplot::plot_grid( p11, p22, p33, nrow  = 1)
corFOMZ <- cor.test(log(B_cell_data$CARpos_FoB), log(B_cell_data$CARpos_MZB))
corGCMZ <- cor.test(log(B_cell_data$CARpos_GCB), log(B_cell_data$CARpos_MZB))
corFOGC <- cor.test(log(B_cell_data$CARpos_FoB), log(B_cell_data$CARpos_GCB))
p11 <-ggplot(data = CAR_cell_counts_df)+
geom_point(aes(x=log(CARpos_FoB), y=log(CARpos_MZB), col=days_bin), size=2)+
#scale_color_manual(values = wesanderson::wes_palette("Zissou1", n=4, type = 'continuous'))+
scale_color_npg()+ guides(col='none') +
labs(x="Log(Counts of CAR positive FoB)", y="Log(Counts of CAR positive MZB)")+
geom_text(x=12.3, y=12.4, label=paste0("r=", round(corFOMZ$estimate, 2)), col='darkred', size=5) +myTheme
p22 <-ggplot(data = CAR_cell_counts_df) +
geom_point(aes(x=log(CARpos_GCB), y=log(CARpos_MZB), col=days_bin), size=2)+
#scale_color_manual(values = wesanderson::wes_palette("Zissou1", n=4, type = 'continuous'))+
scale_color_npg()+ guides(col='none') +
labs(x="Log(Counts of CAR positive GCB)", y="Log(Counts of CAR positive MZB)")+
geom_text(x=11, y=12.4, label=paste0("r=", round(corGCMZ$estimate, 2)), col='darkred', size=5)+ myTheme
p33 <- ggplot(data = CAR_cell_counts_df)+
geom_point(aes(x=log(CARpos_FoB), y=log(CARpos_GCB), col=days_bin), size=2) +
labs(x="Log(Counts of CAR positive FoB)", y="Log(Counts of CAR positive GCB)") +
geom_text(x=12.3, y=14.8, label=paste0("r=", round(corFOGC$estimate, 2)), col='darkred',  size=5) +
scale_color_npg(name = "Days post\nimmunization") + myTheme + theme(legend.position = c(0.85, 0.2))
cowplot::plot_grid( p11, p22, p33, nrow  = 1)
View(B_cell_data)
